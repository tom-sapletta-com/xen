<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>xeen â€” Screenshot â†’ Video</title>
<style>
:root {
  --bg: #0f0f13;
  --surface: #1a1a24;
  --surface2: #24243a;
  --border: #2d2d44;
  --text: #e4e4ef;
  --text2: #8888aa;
  --accent: #7c5cfc;
  --accent2: #5c9cfc;
  --green: #4cda8a;
  --red: #fc5c7c;
  --orange: #fcac5c;
  --radius: 10px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€ */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 1px solid var(--border);
}
.header h1 { font-size: 20px; font-weight: 700; }
.header h1 span { color: var(--accent); }
.header .session-info { color: var(--text2); font-size: 13px; }
.session-select { background: var(--surface2); color: var(--text); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; font-size: 13px; }

/* â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex; gap: 0; border-bottom: 1px solid var(--border);
  padding: 0 24px; background: var(--surface);
}
.tab {
  padding: 12px 20px; cursor: pointer; color: var(--text2);
  font-size: 13px; font-weight: 500; border-bottom: 2px solid transparent;
  transition: all 0.2s; user-select: none;
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab .num {
  display: inline-block; width: 20px; height: 20px; line-height: 20px;
  text-align: center; border-radius: 50%; background: var(--surface2);
  font-size: 11px; margin-right: 6px;
}
.tab.active .num { background: var(--accent); color: white; }

/* â”€â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€ */
.content { padding: 24px; max-width: 1400px; margin: 0 auto; }
.panel { display: none; }
.panel.active { display: block; }
.panel-header { margin-bottom: 20px; }
.panel-header h2 { font-size: 18px; margin-bottom: 4px; }
.panel-header p { color: var(--text2); font-size: 13px; }

/* â”€â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€ */
.frame-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
}
.frame-card {
  background: var(--surface); border: 2px solid var(--border);
  border-radius: var(--radius); overflow: hidden; cursor: pointer;
  transition: all 0.2s; position: relative;
}
.frame-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.frame-card.selected { border-color: var(--green); }
.frame-card img { width: 100%; display: block; }
.frame-card .meta {
  padding: 8px 12px; font-size: 12px; color: var(--text2);
  display: flex; justify-content: space-between;
}
.frame-card .check {
  position: absolute; top: 8px; right: 8px;
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--border); display: flex; align-items: center;
  justify-content: center; font-size: 14px;
}
.frame-card.selected .check { background: var(--green); color: white; }
.frame-card .del-frame {
  position: absolute; top: 8px; left: 8px;
  width: 24px; height: 24px; border-radius: 50%;
  background: rgba(252,92,124,0.0); border: none; color: transparent;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; cursor: pointer; transition: all 0.15s; line-height: 1;
}
.frame-card:hover .del-frame {
  background: rgba(252,92,124,0.85); color: white;
}
.frame-card .del-frame:hover { background: var(--red) !important; }
.frame-card.frame-missing { border-color: var(--red); opacity: 0.75; }
.frame-missing-overlay {
  background: rgba(252,92,124,0.12);
  min-height: 120px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  font-size: 13px; color: var(--red); text-align: center; padding: 12px;
}
.frame-missing-overlay small { color: var(--text2); font-size: 10px; margin-top: 4px; word-break: break-all; }
.missing-frames-banner {
  display: none;
  align-items: flex-start;
  gap: 8px;
  background: rgba(252,172,92,0.12);
  border: 1px solid var(--orange);
  border-radius: var(--radius);
  padding: 12px 16px;
  margin-bottom: 16px;
  font-size: 13px;
  color: var(--orange);
  line-height: 1.5;
}

/* â”€â”€â”€ Trash Sidebar â”€â”€â”€â”€â”€â”€â”€ */
.trash-sidebar {
  position: fixed;
  right: 0; top: 0; bottom: 0;
  width: 260px;
  background: var(--surface);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s;
  z-index: 200;
}
.trash-sidebar.open { transform: translateX(0); }
.trash-toggle {
  position: fixed;
  right: 16px; bottom: 80px;
  width: 48px; height: 48px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 22px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  z-index: 201;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,.4);
}
.trash-toggle:hover { border-color: var(--red); color: var(--red); }
.trash-toggle .badge {
  position: absolute; top: -4px; right: -4px;
  background: var(--red); color: white;
  font-size: 10px; font-weight: 700;
  width: 18px; height: 18px; border-radius: 50%;
  display: none; align-items: center; justify-content: center;
}
.trash-toggle .badge.show { display: flex; }
.trash-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.trash-header h3 { font-size: 14px; font-weight: 600; }
.trash-close {
  background: none; border: none; color: var(--text2);
  cursor: pointer; font-size: 18px; line-height: 1;
}
.trash-close:hover { color: var(--text); }
.trash-list {
  flex: 1; overflow-y: auto;
  padding: 8px;
  display: flex; flex-direction: column; gap: 6px;
}
.trash-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 10px;
  display: flex; align-items: center; gap: 8px;
}
.trash-item img {
  width: 40px; height: 40px; object-fit: cover;
  border-radius: 4px; flex-shrink: 0;
}
.trash-item-info {
  flex: 1; overflow: hidden;
}
.trash-item-name {
  font-size: 11px; color: var(--text2);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.trash-item-actions { display: flex; gap: 4px; }
.trash-item-restore {
  background: none; border: 1px solid var(--border);
  color: var(--text2); border-radius: 6px;
  padding: 2px 6px; font-size: 10px; cursor: pointer;
  white-space: nowrap;
}
.trash-item-restore:hover { border-color: var(--green); color: var(--green); }
.trash-item-purge {
  background: none; border: none;
  color: var(--text2); cursor: pointer; font-size: 13px;
}
.trash-item-purge:hover { color: var(--red); }
.trash-empty-msg {
  text-align: center; padding: 40px 16px;
  color: var(--text2); font-size: 13px;
}
.trash-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
}
.btn-danger { background: var(--red); color: white; width: 100%; }
.btn-danger:hover { background: #e04060; }
.tab-sessions {
  padding: 12px 20px; color: var(--text2);
  font-size: 13px; font-weight: 500;
  text-decoration: none; border-bottom: 2px solid transparent;
  transition: color 0.2s; user-select: none;
  margin-right: 8px; border-right: 1px solid var(--border);
}
.tab-sessions:hover { color: var(--text); }

/* â”€â”€â”€ Tools Toolbar â”€â”€â”€â”€â”€â”€â”€ */
.tools-bar {
  display: flex; flex-wrap: wrap; gap: 6px;
  padding: 10px 0; margin-bottom: 12px;
  border-bottom: 1px solid var(--border);
}
.tool-btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 6px 12px; border-radius: 8px;
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text2); font-size: 12px; cursor: pointer;
  transition: all 0.15s; white-space: nowrap;
}
.tool-btn:hover { border-color: var(--accent); color: var(--text); }
.tool-btn.danger:hover { border-color: var(--red); color: var(--red); }
.tool-btn.success:hover { border-color: var(--green); color: var(--green); }
.tool-btn .icon { font-size: 14px; }
.tool-btn .badge-count {
  background: var(--red); color: white;
  font-size: 10px; font-weight: 700;
  padding: 1px 5px; border-radius: 10px;
  min-width: 16px; text-align: center;
}
.tool-btn.advanced { border-style: dashed; opacity: 0.6; }
.tool-btn.advanced:hover { opacity: 1; }
.tools-divider {
  width: 1px; background: var(--border);
  margin: 0 4px; align-self: stretch;
}

/* â”€â”€â”€ Export Controls â”€â”€â”€â”€â”€â”€â”€ */
.export-options {
  display: grid; gap: 16px; margin-bottom: 20px;
}
.export-row {
  display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: 12px;
}
.export-row label {
  font-size: 13px; font-weight: 500; color: var(--text);
}
.export-row input[type="range"] {
  width: 100%; height: 6px; border-radius: 3px;
  background: var(--surface2); outline: none; -webkit-appearance: none;
}
.export-row input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
  border-radius: 50%; background: var(--accent); cursor: pointer;
  border: 2px solid var(--bg);
}
.export-row input[type="range"]::-moz-range-thumb {
  width: 18px; height: 18px; border-radius: 50%; background: var(--accent);
  cursor: pointer; border: 2px solid var(--bg);
}
.range-value {
  font-size: 14px; font-weight: 600; color: var(--accent);
  min-width: 40px; text-align: center;
}
.range-labels {
  display: flex; justify-content: space-between; font-size: 11px; color: var(--text2);
  margin-top: 4px;
}

.format-buttons {
  display: flex; gap: 12px; margin: 20px 0; flex-wrap: wrap;
}
.format-btn {
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  padding: 16px 20px; border: 2px solid var(--border); border-radius: 12px;
  background: var(--surface1); color: var(--text); cursor: pointer;
  transition: all 0.2s; min-width: 80px;
}
.format-btn:hover {
  border-color: var(--accent); background: var(--surface2); transform: translateY(-2px);
}
.format-btn.active {
  border-color: var(--accent); background: var(--accent); color: var(--bg);
}
.format-icon {
  font-size: 24px;
}
.format-name {
  font-size: 12px; font-weight: 500;
}

.export-links {
  display: grid; gap: 8px; margin-top: 12px;
}
.export-links a {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 8px 12px; background: var(--surface1); border: 1px solid var(--border);
  border-radius: 6px; color: var(--text); text-decoration: none;
  font-size: 13px; transition: all 0.2s;
}
.export-links a:hover {
  border-color: var(--accent); background: var(--surface2);
}
.export-error {
  padding: 8px 12px; background: var(--red); color: white;
  border-radius: 6px; font-size: 13px; margin-bottom: 8px;
}
.mode-toggle {
  margin-left: auto;
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--text2);
}
.mode-toggle input { accent-color: var(--accent); }

/* â”€â”€â”€ Duplicate markers â”€â”€â”€â”€â”€â”€â”€ */
.frame-card.duplicate { border-color: var(--orange); }
.frame-card.duplicate::after {
  content: 'duplikat'; position: absolute;
  bottom: 32px; left: 50%; transform: translateX(-50%);
  background: var(--orange); color: #000;
  font-size: 10px; font-weight: 700;
  padding: 2px 8px; border-radius: 4px;
  pointer-events: none;
}
.dup-similarity {
  position: absolute; top: 36px; right: 8px;
  background: rgba(252,172,92,0.9); color: #000;
  font-size: 10px; font-weight: 600;
  padding: 1px 5px; border-radius: 4px;
}

/* â”€â”€â”€ Center Marker â”€â”€â”€â”€â”€â”€â”€ */
.center-workspace {
  display: flex; gap: 20px;
}
.center-frame-list {
  width: 160px; flex-shrink: 0;
  display: flex; flex-direction: column; gap: 6px;
  max-height: 70vh; overflow-y: auto;
}
.center-thumb {
  border: 2px solid var(--border); border-radius: 6px;
  cursor: pointer; overflow: hidden; position: relative;
}
.center-thumb.active { border-color: var(--accent); }
.center-thumb.marked { border-color: var(--green); }
.center-thumb img { width: 100%; display: block; }
.center-thumb .idx { position: absolute; top: 2px; left: 4px; font-size: 10px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,.8); }

.center-canvas-wrap {
  flex: 1; position: relative; background: var(--surface);
  border-radius: var(--radius); overflow: hidden;
  display: flex; align-items: center; justify-content: center;
}
.center-canvas-wrap img {
  max-width: 100%; max-height: 70vh; cursor: crosshair; display: block;
}
.crosshair {
  position: absolute; pointer-events: none;
}
.crosshair-h, .crosshair-v {
  position: absolute; background: var(--red); opacity: 0.7;
}
.crosshair-h { height: 1px; width: 100%; left: 0; }
.crosshair-v { width: 1px; height: 100%; top: 0; }
.center-dot {
  position: absolute; width: 16px; height: 16px; border-radius: 50%;
  background: var(--red); border: 2px solid white;
  transform: translate(-50%, -50%); pointer-events: none;
  box-shadow: 0 0 8px rgba(252,92,124,.5);
}
.center-info {
  position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,.7);
  padding: 6px 12px; border-radius: 6px; font-size: 12px;
}

/* â”€â”€â”€ Crop Preview â”€â”€â”€â”€â”€â”€â”€ */
.preset-bar {
  display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;
}
.preset-btn {
  padding: 8px 14px; border: 1px solid var(--border); background: var(--surface);
  color: var(--text); border-radius: 6px; cursor: pointer; font-size: 12px;
  transition: all 0.2s;
}
.preset-btn:hover { border-color: var(--accent); }
.preset-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

.crop-preview-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
}
.crop-card {
  background: var(--surface); border-radius: var(--radius);
  overflow: hidden; border: 1px solid var(--border);
}
.crop-card img { width: 100%; display: block; }
.crop-card .info { padding: 8px; font-size: 11px; color: var(--text2); }

/* â”€â”€â”€ Versions â”€â”€â”€â”€â”€â”€â”€ */
.versions-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}
.version-group {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px;
}
.version-group h3 { font-size: 14px; margin-bottom: 12px; color: var(--accent2); }
.version-group .thumbs { display: flex; gap: 6px; overflow-x: auto; }
.version-group .thumbs img { height: 120px; border-radius: 4px; }

/* â”€â”€â”€ Publish â”€â”€â”€â”€â”€â”€â”€ */
.publish-section { max-width: 640px; }
.export-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.export-row { display: flex; gap: 12px; align-items: center; }
.export-row label { width: 120px; font-size: 13px; color: var(--text2); }
.export-row select, .export-row input {
  flex: 1; padding: 8px; background: var(--surface2); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px; font-size: 13px;
}
.social-links { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
.social-btn {
  padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 500;
  cursor: pointer; border: none; color: white; transition: opacity 0.2s;
}
.social-btn:hover { opacity: 0.85; }
.social-btn.twitter { background: #1da1f2; }
.social-btn.linkedin { background: #0077b5; }
.social-btn.facebook { background: #4267b2; }
.social-btn.reddit { background: #ff4500; }
.social-btn.telegram { background: #0088cc; }

/* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  padding: 10px 20px; border: none; border-radius: 8px;
  font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
}
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: #6b4ce8; }
.btn-success { background: var(--green); color: #111; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { border-color: var(--accent); }
.btn-group { display: flex; gap: 8px; margin-top: 16px; }

/* â”€â”€â”€ Upload zone â”€â”€â”€â”€â”€â”€â”€ */
.upload-zone {
  border: 2px dashed var(--border); border-radius: var(--radius);
  padding: 48px; text-align: center; color: var(--text2);
  cursor: pointer; transition: all 0.2s; margin-bottom: 20px;
}
.upload-zone:hover, .upload-zone.dragover {
  border-color: var(--accent); background: rgba(124,92,252,.05);
}
.upload-zone h3 { margin-bottom: 8px; color: var(--text); }

/* â”€â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€ */
.empty-state { text-align: center; padding: 60px; color: var(--text2); }
.empty-state h3 { color: var(--text); margin-bottom: 8px; }

/* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed; bottom: 24px; right: 24px;
  background: var(--surface2); border: 1px solid var(--green);
  padding: 12px 20px; border-radius: 8px; font-size: 13px;
  transform: translateY(80px); opacity: 0; transition: all 0.3s;
  z-index: 1000;
}
.toast.show { transform: translateY(0); opacity: 1; }

/* â”€â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€ */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="header">
  <h1><span>xeen</span> capture</h1>
  <div style="display:flex;align-items:center;gap:12px;">
    <span class="session-info" id="sessionInfo">Brak sesji</span>
    <select class="session-select" id="sessionSelect" onchange="loadSession(this.value)">
      <option value="">â€” wybierz sesjÄ™ â€”</option>
    </select>
  </div>
</div>

<div class="tabs" id="tabs">
  <a class="tab tab-sessions" href="/" title="PowrÃ³t do listy sesji">â† Sesje</a>
  <div class="tab active" data-tab="select">
    <span class="num">1</span>WybÃ³r klatek
  </div>
  <div class="tab" data-tab="center">
    <span class="num">2</span>Åšrodek
  </div>
  <div class="tab" data-tab="crop">
    <span class="num">3</span>Przycinanie
  </div>
  <div class="tab" data-tab="versions">
    <span class="num">4</span>Wersje
  </div>
  <div class="tab" data-tab="publish">
    <span class="num">5</span>Publikacja
  </div>
</div>

<!-- Trash toggle -->
<button class="trash-toggle" onclick="toggleTrash()" title="Kosz">
  ğŸ—‘
  <span class="badge" id="trashBadge"></span>
</button>

<!-- Trash sidebar -->
<div class="trash-sidebar" id="trashSidebar">
  <div class="trash-header">
    <h3>ğŸ—‘ Kosz klatek</h3>
    <button class="trash-close" onclick="toggleTrash()">âœ•</button>
  </div>
  <div class="trash-list" id="trashList">
    <div class="trash-empty-msg">Kosz jest pusty</div>
  </div>
  <div class="trash-footer">
    <button class="btn btn-danger" onclick="emptyFrameTrash()">OprÃ³Å¼nij kosz</button>
  </div>
</div>

<div class="content">

  <!-- â•â•â• Tab 1: Frame Selection â•â•â• -->
  <div class="panel active" id="panel-select">
    <div class="panel-header">
      <h2>WybÃ³r klatek</h2>
      <p>Kliknij aby zaznaczyÄ‡/odznaczyÄ‡ klatki. Zaznaczone przejdÄ… do dalszej edycji.</p>
    </div>

    <div class="tools-bar" id="toolsSelect">
      <button class="tool-btn danger" onclick="findDuplicates()" title="ZnajdÅº klatki podobne >90%">
        <span class="icon">ğŸ”</span> ZnajdÅº duplikaty <span class="badge-count" id="dupCount" style="display:none"></span>
      </button>
      <button class="tool-btn danger" id="btnRemoveDups" onclick="removeDuplicates()" style="display:none" title="UsuÅ„ oznaczone duplikaty">
        <span class="icon">ğŸ—‘</span> UsuÅ„ duplikaty
      </button>
      <button class="tool-btn" onclick="sortByChange()" title="Sortuj wg % zmiany">
        <span class="icon">ğŸ“Š</span> Sortuj wg zmiany
      </button>
      <button class="tool-btn" onclick="invertSelection()" title="OdwrÃ³Ä‡ zaznaczenie">
        <span class="icon">ğŸ”„</span> OdwrÃ³Ä‡
      </button>
      <button class="tool-btn" onclick="selectEveryNth()" title="Zaznacz co N-tÄ… klatkÄ™">
        <span class="icon">#ï¸âƒ£</span> Co N-ta
      </button>
      <div class="tools-divider"></div>
      <button class="tool-btn advanced" onclick="advancedSimilarity()" title="Zaawansowana analiza (wymaga dodatkowych pakietÃ³w)">
        <span class="icon">ğŸ§ </span> AI detekcja
      </button>
      <div class="mode-toggle">
        <input type="checkbox" id="advancedMode" onchange="toggleAdvancedMode(this.checked)">
        <label for="advancedMode">Zaawansowane</label>
      </div>
    </div>

    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
      <h3>ğŸ“¸ PrzeciÄ…gnij screenshoty lub kliknij aby wybraÄ‡</h3>
      <p>Lub uruchom <code>xeen capture</code> w terminalu (wymaga GUI)</p>
      <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="uploadFiles(this.files)">
    </div>

    <div class="missing-frames-banner" id="missingFramesBanner"></div>
    <div id="frameGrid" class="frame-grid"></div>

    <div class="btn-group">
      <button class="btn btn-outline" onclick="selectAllFrames()">Zaznacz wszystkie</button>
      <button class="btn btn-outline" onclick="deselectAllFrames()">Odznacz wszystkie</button>
      <button class="btn btn-primary" onclick="saveSelection(); navigateToTab('center')">Dalej â†’ Åšrodek</button>
    </div>
  </div>

  <!-- â•â•â• Tab 2: Center Marking â•â•â• -->
  <div class="panel" id="panel-center">
    <div class="panel-header">
      <h2>Oznacz Å›rodek</h2>
      <p>Kliknij na obrazie aby wyznaczyÄ‡ punkt centralny. ğŸ”´ = kursor myszy z nagrania (sugestia).</p>
    </div>

    <div class="tools-bar">
      <button class="tool-btn success" onclick="autoCenters()" title="UÅ¼yj pozycji kursora z nagrania">
        <span class="icon">ğŸ¯</span> Auto: kursor myszy
      </button>
      <button class="tool-btn" onclick="centerToMiddle()" title="Ustaw Å›rodek na Å›rodek obrazu">
        <span class="icon">â•</span> Åšrodek obrazu
      </button>
      <button class="tool-btn" onclick="copyCenterToAll()" title="Kopiuj bieÅ¼Ä…cy Å›rodek do wszystkich klatek">
        <span class="icon">ğŸ“‹</span> Kopiuj do wszystkich
      </button>
      <div class="tools-divider"></div>
      <button class="tool-btn advanced" onclick="advancedAutoCenter()" title="AI detekcja punktu zainteresowania">
        <span class="icon">ğŸ§ </span> AI auto-center
      </button>
    </div>

    <div class="center-workspace">
      <div class="center-frame-list" id="centerFrameList"></div>
      <div class="center-canvas-wrap" id="centerCanvasWrap">
        <img id="centerImage" src="" alt="">
        <div class="crosshair-h" id="crossH" style="display:none"></div>
        <div class="crosshair-v" id="crossV" style="display:none"></div>
        <div class="center-dot" id="centerDot" style="display:none"></div>
        <div class="center-info" id="centerInfo">Kliknij na obrazie</div>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-outline" onclick="navigateToTab('select')">â† Wstecz</button>
      <button class="btn btn-outline" onclick="autoCenters()">Auto (kursor myszy)</button>
      <button class="btn btn-primary" onclick="saveCenters(); navigateToTab('crop')">Dalej â†’ Przycinanie</button>
    </div>
  </div>

  <!-- â•â•â• Tab 3: Crop Preview â•â•â• -->
  <div class="panel" id="panel-crop">
    <div class="panel-header">
      <h2>Przycinanie</h2>
      <p>Wybierz format docelowy â€” podglÄ…d przyciÄ™tych klatek wg oznaczonego Å›rodka.</p>
    </div>

    <div class="tools-bar">
      <button class="tool-btn" onclick="previewAllPresets()" title="PodglÄ…d wszystkich formatÃ³w">
        <span class="icon">ğŸ–¼</span> PodglÄ…d wszystkich
      </button>
      <button class="tool-btn" onclick="fitToContent()" title="Dopasuj kadrowanie do treÅ›ci">
        <span class="icon">âœ‚ï¸</span> Dopasuj do treÅ›ci
      </button>
      <button class="tool-btn" onclick="addCustomPreset()" title="Dodaj wÅ‚asny format">
        <span class="icon">â•</span> WÅ‚asny format
      </button>
      <div class="tools-divider"></div>
      <button class="tool-btn advanced" onclick="advancedSmartCrop()" title="AI smart crop (wymaga opencv)">
        <span class="icon">ğŸ§ </span> AI smart crop
      </button>
    </div>

    <div class="preset-bar" id="presetBar"></div>
    <div id="cropPreviewGrid" class="crop-preview-grid"></div>
    <div class="btn-group">
      <button class="btn btn-outline" onclick="navigateToTab('center')">â† Wstecz</button>
      <button class="btn btn-primary" onclick="navigateToTab('versions')">Dalej â†’ Wersje</button>
    </div>
  </div>

  <!-- â•â•â• Tab 4: Multiple Versions â•â•â• -->
  <div class="panel" id="panel-versions">
    <div class="panel-header">
      <h2>PorÃ³wnanie wersji</h2>
      <p>PodglÄ…d wszystkich formatÃ³w obok siebie.</p>
    </div>

    <div class="tools-bar">
      <button class="tool-btn success" onclick="generateVersions()" title="Generuj zaznaczone wersje">
        <span class="icon">âš™ï¸</span> Generuj wersje
      </button>
      <button class="tool-btn" onclick="compareVersionsSideBySide()" title="Bok-do-boku">
        <span class="icon">ğŸ”²</span> PorÃ³wnanie bok-do-boku
      </button>
      <button class="tool-btn" onclick="downloadAllVersions()" title="Pobierz wszystkie wersje">
        <span class="icon">ğŸ“¥</span> Pobierz wszystkie
      </button>
      <div class="tools-divider"></div>
      <button class="tool-btn advanced" onclick="advancedUpscale()" title="AI upscale (wymaga Real-ESRGAN)">
        <span class="icon">ğŸ§ </span> AI upscale
      </button>
    </div>

    <div class="preset-bar" id="versionPresetBar"></div>
    <div class="btn-group" style="margin-bottom:16px">
      <button class="btn btn-primary" onclick="generateVersions()">Generuj wybrane wersje</button>
    </div>
    <div id="versionsGrid" class="versions-grid"></div>
    <div class="btn-group">
      <button class="btn btn-outline" onclick="navigateToTab('crop')">â† Wstecz</button>
      <button class="btn btn-primary" onclick="navigateToTab('publish')">Dalej â†’ Publikacja</button>
    </div>
  </div>

  <!-- â•â•â• Tab 5: Publish â•â•â• -->
  <div class="panel" id="panel-publish">
    <div class="panel-header">
      <h2>Eksport i publikacja</h2>
      <p>Eksportuj jako wideo, GIF lub paczkÄ™ PNG, i udostÄ™pnij.</p>
    </div>

    <div class="tools-bar">
      <button class="tool-btn success" onclick="exportSession()" title="Eksportuj z aktualnymi ustawieniami">
        <span class="icon">ğŸ“¦</span> Szybki eksport
      </button>
      <button class="tool-btn" onclick="exportAllFormats()" title="Eksportuj we wszystkich formatach">
        <span class="icon">ğŸ“</span> Eksport wszystkich
      </button>
      <button class="tool-btn" onclick="addWatermark()" title="Dodaj znak wodny">
        <span class="icon">ğŸŒ</span> Znak wodny
      </button>
      <div class="tools-divider"></div>
      <button class="tool-btn advanced" onclick="advancedVideoExport()" title="FFmpeg zaawansowany (wymaga ffmpeg)">
        <span class="icon">ğŸ§ </span> Zaawansowany eksport
      </button>
    </div>

    <div class="publish-section">
      <div class="export-options">
        <div class="export-row">
          <label>Format:</label>
          <select id="exportPreset">
            <option value="">Åadowanie...</option>
          </select>
        </div>
        <div class="export-row">
          <label>FPS:</label>
          <input type="range" id="exportFps" min="1" max="10" value="2" step="1" 
                 oninput="document.getElementById('fpsValue').textContent = this.value">
          <span id="fpsValue" class="range-value">2</span>
          <div class="range-labels">
            <span>1</span><span>5</span><span>10</span>
          </div>
        </div>
        <div class="export-row">
          <label>Czas/klatka:</label>
          <input type="range" id="exportDuration" min="0.5" max="5" value="2" step="0.5" 
                 oninput="document.getElementById('durationValue').textContent = this.value + 's'">
          <span id="durationValue" class="range-value">2s</span>
          <div class="range-labels">
            <span>0.5s</span><span>2.5s</span><span>5s</span>
          </div>
        </div>
      </div>

      <div class="format-buttons">
        <button class="format-btn" onclick="exportFormat('video')" data-format="video">
          <span class="format-icon">ğŸ¬</span>
          <span class="format-name">MP4</span>
        </button>
        <button class="format-btn" onclick="exportFormat('gif')" data-format="gif">
          <span class="format-icon">ğŸ¨</span>
          <span class="format-name">GIF</span>
        </button>
        <button class="format-btn" onclick="exportFormat('webm')" data-format="webm">
          <span class="format-icon">ğŸŒ</span>
          <span class="format-name">WebM</span>
        </button>
        <button class="format-btn" onclick="exportFormat('zip')" data-format="zip">
          <span class="format-icon">ğŸ“</span>
          <span class="format-name">ZIP</span>
        </button>
      </div>

      <button class="btn btn-success" onclick="exportAllFormats()" id="exportBtn">
        âš¡ Generuj wszystkie formaty
      </button>

      <div id="exportResults" style="margin-top:16px;display:none;">
        <h4>Gotowe pliki:</h4>
        <div id="exportLinks" class="export-links"></div>
      </div>

      <h3 style="margin-top:32px; font-size:15px;">UdostÄ™pnij</h3>
      <div class="social-links" id="socialLinks"></div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentSession = null;
let sessionData = null;
let selectedFrames = new Set();
let centerMarks = {};  // frameIndex -> {x, y}
let currentCenterFrame = 0;
let activePreset = 'twitter_post';
let presets = {};
let duplicateIndices = new Set();  // indices marked as duplicates
let duplicatePairs = [];           // [{frame_a, frame_b, similarity}]
let advancedModeOn = false;

// â”€â”€â”€ URL Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseURL() {
  const path = window.location.pathname;
  const params = new URLSearchParams(window.location.search);
  
  // Parse session and tab from URL
  if (path.startsWith('/session/')) {
    const parts = path.split('/');
    const sessionName = parts[2];
    const tabName = parts[4] || 'select'; // default to select tab
    
    return { sessionName, tabName };
  }
  
  return { sessionName: null, tabName: 'select' };
}

function updateURL(sessionName = null, tabName = null) {
  let url = '/';
  
  if (sessionName) {
    url = `/session/${sessionName}/tab/${tabName || 'select'}`;
  }
  
  window.history.pushState({}, '', url);
}

function navigateToSession(sessionName, tabName = 'select') {
  updateURL(sessionName, tabName);
  loadSession(sessionName);
  if (tabName !== 'select') {
    switchTab(tabName);
  }
}

function navigateToTab(tabName) {
  if (currentSession) {
    updateURL(currentSession, tabName);
  }
  switchTab(tabName);
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
  await loadSessions();
  await loadPresets();
  setupDragDrop();
  setupCenterCanvas();
  buildSocialLinks();
  updateTabHandlers();
  
  // Handle browser back/forward
  window.addEventListener('popstate', () => {
    const { sessionName, tabName } = parseURL();
    if (sessionName && sessionName !== currentSession) {
      loadSession(sessionName);
    }
    if (tabName) {
      switchTab(tabName);
    }
  });
  
  // Load initial state from URL
  const { sessionName, tabName } = parseURL();
  if (sessionName) {
    await loadSession(sessionName);
    if (tabName !== 'select') {
      switchTab(tabName);
    }
  }
});

async function api(path, opts = {}) {
  const res = await fetch('/api' + path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  if (!res.ok) throw new Error(`API error: ${res.status}`);
  return res.json();
}

// â”€â”€â”€ Sessions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSessions() {
  const sessions = await api('/sessions');
  const sel = document.getElementById('sessionSelect');
  sel.innerHTML = '<option value="">â€” wybierz sesjÄ™ â€”</option>';
  sessions.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.name;
    opt.textContent = `${s.name} (${s.frame_count} kl.)`;
    sel.appendChild(opt);
  });
  
  // Auto-load first session if no URL session specified
  const { sessionName } = parseURL();
  if (!sessionName && sessions.length > 0) {
    sel.value = sessions[0].name;
    loadSession(sessions[0].name);
  } else if (sessionName) {
    sel.value = sessionName;
  }
}

async function loadSession(name) {
  if (!name) return;
  currentSession = name;
  sessionData = await api(`/sessions/${name}`);
  document.getElementById('sessionInfo').textContent =
    `${sessionData.frame_count} klatek â€¢ ${sessionData.duration.toFixed(1)}s`;

  // Update URL to reflect current session
  updateURL(name, 'select');

  // Show warning if frames are missing on disk
  const missingBanner = document.getElementById('missingFramesBanner');
  const missing = sessionData._missing_frames || [];
  if (missing.length > 0) {
    missingBanner.style.display = 'flex';
    missingBanner.innerHTML = `
      <span>âš ï¸ <strong>${missing.length} klatek brakuje na dysku</strong> â€” pliki nie zostaÅ‚y zapisane podczas nagrywania:<br>
      <small style="font-family:monospace;opacity:.8">${missing.join(', ')}</small></span>
      <button onclick="document.getElementById('missingFramesBanner').style.display='none'" style="background:none;border:none;color:inherit;cursor:pointer;font-size:18px;margin-left:12px">âœ•</button>
    `;
  } else {
    missingBanner.style.display = 'none';
  }

  // ZaÅ‚aduj zaznaczenie
  const prev = sessionData.selected_frames;
  selectedFrames = new Set(prev || sessionData.frames.map((_, i) => i));

  // ZaÅ‚aduj centra
  centerMarks = {};
  const cc = sessionData.custom_centers || {};
  for (const [k, v] of Object.entries(cc)) {
    centerMarks[parseInt(k)] = v;
  }

  renderFrameGrid();
}

// â”€â”€â”€ Tab 1: Frame Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFrameGrid() {
  const grid = document.getElementById('frameGrid');
  grid.innerHTML = '';
  if (!sessionData) return;

  const missingSet = new Set(sessionData._missing_frames || []);

  sessionData.frames.forEach((f, i) => {
    const isMissing = missingSet.has(f.filename);
    const isDup = duplicateIndices.has(i);
    const card = document.createElement('div');
    card.className = `frame-card${selectedFrames.has(i) ? ' selected' : ''}${isMissing ? ' frame-missing' : ''}${isDup ? ' duplicate' : ''}`;
    card.onclick = () => toggleFrame(i, card);

    // Find best similarity match for this duplicate
    let simLabel = '';
    if (isDup) {
      const pair = duplicatePairs.find(p => p.frame_b === i);
      if (pair) simLabel = `<span class="dup-similarity">${pair.similarity}%</span>`;
    }

    card.innerHTML = isMissing
      ? `
        <div class="frame-missing-overlay">âŒ Brak pliku<br><small>${f.filename}</small></div>
        <div class="check">${selectedFrames.has(i) ? 'âœ“' : ''}</div>
        <button class="del-frame" title="UsuÅ„ klatkÄ™" onclick="event.stopPropagation(); deleteFrame(${i})">âœ•</button>
        <div class="meta"><span>#${i+1} â€¢ ${f.timestamp.toFixed(1)}s</span><span style="color:var(--red)">âš  brak pliku</span></div>
      `
      : `
        <img src="/api/sessions/${currentSession}/frames/${f.filename}" loading="lazy">
        <div class="check">${selectedFrames.has(i) ? 'âœ“' : ''}</div>
        ${simLabel}
        <button class="del-frame" title="UsuÅ„ klatkÄ™" onclick="event.stopPropagation(); deleteFrame(${i})">âœ•</button>
        <div class="meta">
          <span>#${i+1} â€¢ ${f.timestamp.toFixed(1)}s</span>
          <span>Î”${f.change_pct.toFixed(0)}% â€¢ ğŸ–±(${f.mouse_x},${f.mouse_y})</span>
        </div>
      `;
    grid.appendChild(card);
  });
}

function toggleFrame(idx, card) {
  if (selectedFrames.has(idx)) {
    selectedFrames.delete(idx);
    card.classList.remove('selected');
    card.querySelector('.check').textContent = '';
  } else {
    selectedFrames.add(idx);
    card.classList.add('selected');
    card.querySelector('.check').textContent = 'âœ“';
  }
}

function selectAllFrames() {
  sessionData.frames.forEach((_, i) => selectedFrames.add(i));
  renderFrameGrid();
}

function deselectAllFrames() {
  selectedFrames.clear();
  renderFrameGrid();
}

// â”€â”€â”€ Frame Trash â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const frameTrash = [];  // { sessionName, frame, origIdx }

function toggleTrash() {
  document.getElementById('trashSidebar').classList.toggle('open');
}

function updateTrashBadge() {
  const badge = document.getElementById('trashBadge');
  badge.textContent = frameTrash.length;
  badge.classList.toggle('show', frameTrash.length > 0);
}

function renderTrashList() {
  const list = document.getElementById('trashList');
  if (frameTrash.length === 0) {
    list.innerHTML = '<div class="trash-empty-msg">Kosz jest pusty</div>';
    return;
  }
  list.innerHTML = '';
  frameTrash.forEach((item, i) => {
    const el = document.createElement('div');
    el.className = 'trash-item';
    el.innerHTML = `
      <img src="/api/sessions/${item.sessionName}/frames/${item.frame.filename}" onerror="this.style.display='none'">
      <div class="trash-item-info">
        <div class="trash-item-name">#${item.origIdx + 1} â€¢ ${item.frame.filename}</div>
        <div class="trash-item-actions">
          <button class="trash-item-restore" onclick="restoreFrame(${i})">â†© PrzywrÃ³Ä‡</button>
          <button class="trash-item-purge" onclick="purgeFrame(${i})" title="UsuÅ„ trwale">âœ•</button>
        </div>
      </div>
    `;
    list.appendChild(el);
  });
}

function deleteFrame(idx) {
  if (!currentSession || !sessionData) return;
  const f = sessionData.frames[idx];
  if (!f) return;

  // Move to trash (soft delete)
  frameTrash.unshift({ sessionName: currentSession, frame: { ...f }, origIdx: idx });
  updateTrashBadge();

  // Remove from local state
  sessionData.frames.splice(idx, 1);
  sessionData.frame_count = sessionData.frames.length;
  sessionData.frames.forEach((fr, i) => { fr.index = i; });
  selectedFrames = new Set([...selectedFrames].filter(x => x !== idx).map(x => x > idx ? x - 1 : x));
  renderFrameGrid();
  renderTrashList();
  toast(`Klatka #${idx + 1} w koszu â€” â†© przywrÃ³Ä‡ w koszu`);
}

async function restoreFrame(i) {
  const item = frameTrash.splice(i, 1)[0];
  // Re-insert at original position (or end)
  const insertAt = Math.min(item.origIdx, sessionData.frames.length);
  sessionData.frames.splice(insertAt, 0, item.frame);
  sessionData.frame_count = sessionData.frames.length;
  sessionData.frames.forEach((fr, j) => { fr.index = j; });
  selectedFrames = new Set([...selectedFrames].map(x => x >= insertAt ? x + 1 : x));
  selectedFrames.add(insertAt);
  renderFrameGrid();
  updateTrashBadge();
  renderTrashList();
  toast(`Klatka przywrÃ³cona na pozycjÄ™ #${insertAt + 1}`);
}

async function purgeFrame(i) {
  const item = frameTrash.splice(i, 1)[0];
  try {
    await fetch(`/api/sessions/${item.sessionName}/frames/${item.frame.filename}`, { method: 'DELETE' });
  } catch (e) { /* ignore */ }
  updateTrashBadge();
  renderTrashList();
  toast(`Klatka trwale usuniÄ™ta`);
}

async function emptyFrameTrash() {
  await Promise.all(frameTrash.map(item =>
    fetch(`/api/sessions/${item.sessionName}/frames/${item.frame.filename}`, { method: 'DELETE' }).catch(() => {})
  ));
  frameTrash.length = 0;
  updateTrashBadge();
  renderTrashList();
  toast('Kosz oprÃ³Å¼niony');
}

async function saveSelection() {
  if (!currentSession) return;
  await api(`/sessions/${currentSession}/select`, {
    method: 'POST',
    body: { selected_indices: [...selectedFrames].sort() },
  });
  toast('Zapisano wybÃ³r klatek');
}

// â”€â”€â”€ Tools: Tab 1 (Select) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function findDuplicates() {
  if (!currentSession) return;
  toast('Szukam duplikatÃ³w...');
  try {
    const res = await api(`/sessions/${currentSession}/similarity?threshold=90`);
    duplicatePairs = res.duplicate_pairs || [];
    duplicateIndices = new Set(res.duplicate_indices || []);

    const badge = document.getElementById('dupCount');
    const btn = document.getElementById('btnRemoveDups');
    if (duplicateIndices.size > 0) {
      badge.textContent = duplicateIndices.size;
      badge.style.display = 'inline-block';
      btn.style.display = '';
      toast(`Znaleziono ${duplicateIndices.size} duplikatÃ³w (${duplicatePairs.length} par â‰¥90%)`);
    } else {
      badge.style.display = 'none';
      btn.style.display = 'none';
      toast('Brak duplikatÃ³w â€” wszystkie klatki sÄ… unikalne âœ…');
    }
    renderFrameGrid();
  } catch (e) {
    toast('BÅ‚Ä…d analizy podobieÅ„stwa: ' + e.message);
  }
}

function removeDuplicates() {
  if (duplicateIndices.size === 0) return;
  const toRemove = [...duplicateIndices].sort((a, b) => b - a);
  toRemove.forEach(idx => deleteFrame(idx));
  duplicateIndices.clear();
  duplicatePairs = [];
  document.getElementById('dupCount').style.display = 'none';
  document.getElementById('btnRemoveDups').style.display = 'none';
  toast(`UsuniÄ™to ${toRemove.length} duplikatÃ³w do kosza`);
}

function sortByChange() {
  if (!sessionData) return;
  const sorted = sessionData.frames.slice().sort((a, b) => b.change_pct - a.change_pct);
  const origOrder = sessionData.frames.map(f => f.filename);
  sessionData.frames = sorted;
  sessionData.frames.forEach((f, i) => { f.index = i; });
  selectedFrames = new Set(sessionData.frames.map((_, i) => i));
  renderFrameGrid();
  toast('Posortowano wg % zmiany (malejÄ…co)');
}

function invertSelection() {
  if (!sessionData) return;
  const newSel = new Set();
  sessionData.frames.forEach((_, i) => {
    if (!selectedFrames.has(i)) newSel.add(i);
  });
  selectedFrames = newSel;
  renderFrameGrid();
  toast(`OdwrÃ³cono zaznaczenie â€” ${selectedFrames.size} zaznaczonych`);
}

function selectEveryNth() {
  const n = parseInt(prompt('Zaznacz co ktÃ³rÄ… klatkÄ™? (np. 2 = co drugÄ…)', '2'));
  if (!n || n < 1 || !sessionData) return;
  selectedFrames.clear();
  sessionData.frames.forEach((_, i) => {
    if (i % n === 0) selectedFrames.add(i);
  });
  renderFrameGrid();
  toast(`Zaznaczono co ${n}. klatkÄ™ â€” ${selectedFrames.size} zaznaczonych`);
}

// â”€â”€â”€ Tools: Tab 2 (Center) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function centerToMiddle() {
  if (!sessionData) return;
  [...selectedFrames].forEach(idx => {
    const f = sessionData.frames[idx];
    if (f) centerMarks[idx] = { x: Math.round(f.width / 2), y: Math.round(f.height / 2) };
  });
  renderCenterPanel();
  toast('Åšrodek ustawiony na Å›rodek obrazu dla zaznaczonych klatek');
}

function copyCenterToAll() {
  if (!sessionData) return;
  const current = centerMarks[currentCenterFrame];
  if (!current) { toast('Najpierw oznacz Å›rodek na bieÅ¼Ä…cej klatce'); return; }
  [...selectedFrames].forEach(idx => {
    centerMarks[idx] = { ...current };
  });
  renderCenterPanel();
  toast(`Skopiowano Å›rodek (${current.x}, ${current.y}) do ${selectedFrames.size} klatek`);
}

// â”€â”€â”€ Tools: Tab 3 (Crop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function previewAllPresets() {
  toast('PodglÄ…d wszystkich formatÃ³w â€” wkrÃ³tce');
}

function fitToContent() {
  toast('Dopasowanie do treÅ›ci â€” wymaga analizy OCR zawartoÅ›ci klatek');
}

function addCustomPreset() {
  const w = parseInt(prompt('SzerokoÅ›Ä‡ (px):', '1080'));
  const h = parseInt(prompt('WysokoÅ›Ä‡ (px):', '1080'));
  if (!w || !h) return;
  const name = prompt('Nazwa formatu:', `custom_${w}x${h}`) || `custom_${w}x${h}`;
  presets[name] = { width: w, height: h, label: name };
  toast(`Dodano format ${name} (${w}Ã—${h})`);
}

// â”€â”€â”€ Tools: Tab 4 (Versions) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function compareVersionsSideBySide() {
  toast('PorÃ³wnanie bok-do-boku â€” wkrÃ³tce');
}

function downloadAllVersions() {
  toast('Pobieranie wszystkich wersji â€” wkrÃ³tce');
}

// â”€â”€â”€ Tools: Tab 5 (Publish) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function exportAllFormats() {
  toast('Eksport we wszystkich formatach â€” wkrÃ³tce');
}

function addWatermark() {
  toast('Znak wodny â€” wkrÃ³tce');
}

// â”€â”€â”€ Advanced Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toggleAdvancedMode(on) {
  advancedModeOn = on;
  document.querySelectorAll('.tool-btn.advanced').forEach(btn => {
    btn.style.display = on ? '' : 'none';
  });
}

function advancedSimilarity() {
  toast('ğŸ§  AI detekcja wymaga: pip install torch torchvision\nUÅ¼yj "make install" aby zainstalowaÄ‡');
}
function advancedAutoCenter() {
  toast('ğŸ§  AI auto-center wymaga: pip install torch torchvision\nUÅ¼yj "make install" aby zainstalowaÄ‡');
}
function advancedSmartCrop() {
  toast('ğŸ§  AI smart crop wymaga: pip install opencv-python-headless\nUÅ¼yj "make install" aby zainstalowaÄ‡');
}
function advancedUpscale() {
  toast('ğŸ§  AI upscale wymaga: pip install realesrgan\nUÅ¼yj "make install" aby zainstalowaÄ‡');
}
function advancedVideoExport() {
  toast('ğŸ§  Zaawansowany eksport wymaga: sudo apt install ffmpeg\nUÅ¼yj "make install" aby zainstalowaÄ‡');
}

// â”€â”€â”€ Init advanced mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  toggleAdvancedMode(false);
});

// â”€â”€â”€ Tab 2: Center Marking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupCenterCanvas() {
  const wrap = document.getElementById('centerCanvasWrap');
  const img = document.getElementById('centerImage');

  img.addEventListener('click', (e) => {
    const rect = img.getBoundingClientRect();
    const scaleX = img.naturalWidth / rect.width;
    const scaleY = img.naturalHeight / rect.height;
    const x = Math.round((e.clientX - rect.left) * scaleX);
    const y = Math.round((e.clientY - rect.top) * scaleY);
    setCenter(currentCenterFrame, x, y);
  });

  img.addEventListener('mousemove', (e) => {
    const rect = img.getBoundingClientRect();
    const px = e.clientX - rect.left;
    const py = e.clientY - rect.top;
    document.getElementById('crossH').style.cssText = `display:block;top:${py + rect.top - wrap.getBoundingClientRect().top}px`;
    document.getElementById('crossV').style.cssText = `display:block;left:${px + rect.left - wrap.getBoundingClientRect().left}px`;
  });
}

function renderCenterPanel() {
  if (!sessionData) return;
  const list = document.getElementById('centerFrameList');
  list.innerHTML = '';
  const selected = [...selectedFrames].sort();

  selected.forEach((idx, i) => {
    const f = sessionData.frames[idx];
    const thumb = document.createElement('div');
    const isMarked = centerMarks[idx] != null;
    thumb.className = `center-thumb${i === 0 ? ' active' : ''}${isMarked ? ' marked' : ''}`;
    thumb.onclick = () => showCenterFrame(idx);
    thumb.innerHTML = `
      <img src="/api/sessions/${currentSession}/frames/${f.filename}">
      <span class="idx">#${idx+1} ${isMarked ? 'âœ“' : ''}</span>
    `;
    list.appendChild(thumb);
  });

  if (selected.length > 0) showCenterFrame(selected[0]);
}

function showCenterFrame(idx) {
  currentCenterFrame = idx;
  const f = sessionData.frames[idx];
  const img = document.getElementById('centerImage');
  img.src = `/api/sessions/${currentSession}/frames/${f.filename}`;

  // PokaÅ¼ zaznaczony Å›rodek lub sugestiÄ™
  const center = centerMarks[idx] || {
    x: f.suggested_center_x,
    y: f.suggested_center_y,
  };
  img.onload = () => updateCenterDot(center.x, center.y);

  // PodÅ›wietl thumb
  document.querySelectorAll('.center-thumb').forEach(t => t.classList.remove('active'));
  const thumbs = document.querySelectorAll('.center-thumb');
  const selected = [...selectedFrames].sort();
  const thumbIdx = selected.indexOf(idx);
  if (thumbIdx >= 0 && thumbs[thumbIdx]) thumbs[thumbIdx].classList.add('active');

  document.getElementById('centerInfo').textContent =
    centerMarks[idx]
      ? `Åšrodek: (${center.x}, ${center.y})`
      : `Sugestia (kursor): (${center.x}, ${center.y}) â€” kliknij aby ustawiÄ‡`;
}

function setCenter(idx, x, y) {
  centerMarks[idx] = { x, y };
  updateCenterDot(x, y);
  document.getElementById('centerInfo').textContent = `Åšrodek: (${x}, ${y})`;

  // Update thumb
  const thumbs = document.querySelectorAll('.center-thumb');
  const selected = [...selectedFrames].sort();
  const thumbIdx = selected.indexOf(idx);
  if (thumbIdx >= 0 && thumbs[thumbIdx]) {
    thumbs[thumbIdx].classList.add('marked');
    thumbs[thumbIdx].querySelector('.idx').textContent = `#${idx+1} âœ“`;
  }

  toast(`Åšrodek klatki #${idx+1}: (${x}, ${y})`);
}

function updateCenterDot(cx, cy) {
  const img = document.getElementById('centerImage');
  const dot = document.getElementById('centerDot');
  const rect = img.getBoundingClientRect();
  const wrap = document.getElementById('centerCanvasWrap').getBoundingClientRect();

  const px = (cx / img.naturalWidth) * rect.width + (rect.left - wrap.left);
  const py = (cy / img.naturalHeight) * rect.height + (rect.top - wrap.top);

  dot.style.display = 'block';
  dot.style.left = px + 'px';
  dot.style.top = py + 'px';
}

function autoCenters() {
  [...selectedFrames].forEach(idx => {
    const f = sessionData.frames[idx];
    if (!centerMarks[idx]) {
      centerMarks[idx] = {
        x: f.suggested_center_x || f.mouse_x || Math.round(f.width / 2),
        y: f.suggested_center_y || f.mouse_y || Math.round(f.height / 2),
      };
    }
  });
  renderCenterPanel();
  toast('Auto-Å›rodki ustawione na pozycji kursora');
}

async function saveCenters() {
  if (!currentSession) return;
  const marks = Object.entries(centerMarks).map(([k, v]) => ({
    frame_index: parseInt(k), center_x: v.x, center_y: v.y,
  }));
  await api(`/sessions/${currentSession}/centers`, {
    method: 'POST',
    body: { marks },
  });
  toast('Zapisano Å›rodki');
}

// â”€â”€â”€ Tab 3: Crop Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPresets() {
  presets = await api('/presets');
  renderPresetBars();
  populateExportPreset();
}

function renderPresetBars() {
  ['presetBar', 'versionPresetBar'].forEach(id => {
    const bar = document.getElementById(id);
    bar.innerHTML = '';
    for (const [key, p] of Object.entries(presets)) {
      const btn = document.createElement('button');
      btn.className = `preset-btn${key === activePreset ? ' active' : ''}`;
      btn.textContent = p.label;
      btn.dataset.preset = key;
      if (id === 'presetBar') {
        btn.onclick = () => { activePreset = key; updatePresetBtns(); loadCropPreview(); };
      } else {
        btn.onclick = () => btn.classList.toggle('active');
      }
      bar.appendChild(btn);
    }
  });
}

function updatePresetBtns() {
  document.querySelectorAll('#presetBar .preset-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.preset === activePreset);
  });
}

async function loadCropPreview() {
  if (!currentSession) return;
  const grid = document.getElementById('cropPreviewGrid');
  grid.innerHTML = '<div class="spinner"></div>';

  const result = await api(`/sessions/${currentSession}/crop-preview`, {
    method: 'POST',
    body: {
      preset: activePreset,
      frame_indices: [...selectedFrames].sort(),
    },
  });

  grid.innerHTML = '';
  result.previews.forEach(p => {
    const card = document.createElement('div');
    card.className = 'crop-card';
    card.innerHTML = `
      <img src="/api/sessions/${currentSession}/preview/${p.filename}" loading="lazy">
      <div class="info">
        Klatka #${p.index+1} â€¢ Å›rodek: (${p.center.x}, ${p.center.y}) â€¢ ${p.target.w}Ã—${p.target.h}
      </div>
    `;
    grid.appendChild(card);
  });
}

// â”€â”€â”€ Tab 4: Versions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateVersions() {
  if (!currentSession) return;
  const selected = [];
  document.querySelectorAll('#versionPresetBar .preset-btn.active').forEach(b => {
    selected.push(b.dataset.preset);
  });
  if (selected.length === 0) { toast('Zaznacz przynajmniej jeden format'); return; }

  const grid = document.getElementById('versionsGrid');
  grid.innerHTML = '<div class="spinner"></div>';

  const result = await api(`/sessions/${currentSession}/generate-versions`, {
    method: 'POST',
    body: { presets: selected, frame_indices: [...selectedFrames].sort() },
  });

  grid.innerHTML = '';
  for (const [key, ver] of Object.entries(result)) {
    const group = document.createElement('div');
    group.className = 'version-group';
    let thumbsHtml = ver.previews.map(p =>
      `<img src="/api/sessions/${currentSession}/preview/${p.filename}" title="Klatka #${p.index+1}">`
    ).join('');
    group.innerHTML = `
      <h3>${ver.label} (${ver.target.w}Ã—${ver.target.h})</h3>
      <div class="thumbs">${thumbsHtml}</div>
    `;
    grid.appendChild(group);
  }
}

// â”€â”€â”€ Tab 5: Publish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateExportPreset() {
  const sel = document.getElementById('exportPreset');
  sel.innerHTML = '';
  for (const [key, p] of Object.entries(presets)) {
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = p.label;
    sel.appendChild(opt);
  }
}

async function exportFormat(format) {
  if (!currentSession) return;
  
  // Update button states
  document.querySelectorAll('.format-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.format === format);
  });
  
  const btn = document.querySelector(`[data-format="${format}"]`);
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<span class="spinner"></span><span class="format-name">GenerujÄ™...</span>';
  btn.disabled = true;

  try {
    const result = await api(`/sessions/${currentSession}/export`, {
      method: 'POST',
      body: {
        preset: document.getElementById('exportPreset').value,
        format: format,
        duration_per_frame: parseFloat(document.getElementById('exportDuration').value),
        fps: parseInt(document.getElementById('exportFps').value),
        frame_indices: [...selectedFrames].sort(),
      },
    });

    // Show result in export results section
    document.getElementById('exportResults').style.display = 'block';
    const linksContainer = document.getElementById('exportLinks');
    
    // Check if link already exists
    let existingLink = document.querySelector(`[data-format-link="${format}"]`);
    if (!existingLink) {
      existingLink = document.createElement('a');
      existingLink.dataset.formatLink = format;
      linksContainer.appendChild(existingLink);
    }
    
    existingLink.href = result.download_url;
    existingLink.textContent = `â¬‡ ${result.filename} (${result.size_mb} MB)`;
    
    toast(`Eksport ${format.toUpperCase()} gotowy!`);
  } catch (e) {
    toast('BÅ‚Ä…d eksportu: ' + e.message);
  } finally {
    btn.innerHTML = originalHtml;
    btn.disabled = false;
  }
}

async function exportAllFormats() {
  if (!currentSession) return;
  
  const btn = document.getElementById('exportBtn');
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<span class="spinner"></span> GenerujÄ™ wszystkie formaty...';
  btn.disabled = true;
  
  const formats = ['video', 'gif', 'webm', 'zip'];
  const results = {};
  
  try {
    // Export all formats in parallel
    const exportPromises = formats.map(format => 
      api(`/sessions/${currentSession}/export`, {
        method: 'POST',
        body: {
          preset: document.getElementById('exportPreset').value,
          format: format,
          duration_per_frame: parseFloat(document.getElementById('exportDuration').value),
          fps: parseInt(document.getElementById('exportFps').value),
          frame_indices: [...selectedFrames].sort(),
        },
      }).then(result => ({ format, result }))
      .catch(error => ({ format, error }))
    );
    
    const exportResults = await Promise.all(exportPromises);
    
    // Show results
    document.getElementById('exportResults').style.display = 'block';
    const linksContainer = document.getElementById('exportLinks');
    linksContainer.innerHTML = '';
    
    exportResults.forEach(({ format, result, error }) => {
      if (error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'export-error';
        errorDiv.textContent = `âŒ ${format.toUpperCase()}: ${error.message}`;
        linksContainer.appendChild(errorDiv);
      } else {
        const link = document.createElement('a');
        link.href = result.download_url;
        link.textContent = `â¬‡ ${result.filename} (${result.size_mb} MB)`;
        link.dataset.formatLink = format;
        linksContainer.appendChild(link);
      }
    });
    
    toast('Wszystkie formaty wygenerowane!');
  } catch (e) {
    toast('BÅ‚Ä…d eksportu: ' + e.message);
  } finally {
    btn.innerHTML = originalHtml;
    btn.disabled = false;
  }
}

function buildSocialLinks() {
  const container = document.getElementById('socialLinks');
  const links = {
    twitter: { label: 'Twitter / X', class: 'twitter' },
    linkedin: { label: 'LinkedIn', class: 'linkedin' },
    facebook: { label: 'Facebook', class: 'facebook' },
    reddit: { label: 'Reddit', class: 'reddit' },
    telegram: { label: 'Telegram', class: 'telegram' },
  };
  for (const [key, cfg] of Object.entries(links)) {
    const btn = document.createElement('button');
    btn.className = `social-btn ${cfg.class}`;
    btn.textContent = cfg.label;
    btn.onclick = () => {
      const text = encodeURIComponent(`Check out this demo!`);
      const url = encodeURIComponent(window.location.href);
      // Will be populated from social links API
      window.open(`https://${key}.com`, '_blank');
    };
    container.appendChild(btn);
  }
}

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDragDrop() {
  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    uploadFiles(e.dataTransfer.files);
  });
}

async function uploadFiles(files) {
  if (!files.length) return;
  const fd = new FormData();
  for (const f of files) fd.append('files', f);

  const res = await fetch('/api/sessions/upload', { method: 'POST', body: fd });
  const data = await res.json();

  toast(`ZaÅ‚adowano ${data.frame_count} obrazÃ³w`);
  await loadSessions();
  document.getElementById('sessionSelect').value = data.name;
  await loadSession(data.name);
}

// â”€â”€â”€ Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === `panel-${name}`));

  // Lazy load tab content
  if (name === 'center') renderCenterPanel();
  if (name === 'crop') loadCropPreview();
}

// Update tab click handlers to use navigation
function updateTabHandlers() {
  document.querySelectorAll('.tab').forEach(tab => {
    const tabName = tab.dataset.tab;
    tab.onclick = () => navigateToTab(tabName);
  });
}

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
